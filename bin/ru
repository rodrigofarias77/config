#!/bin/bash

[ "$1" = -s ] && s=1 && shift
[ "$1" = -u ] && u=1 && shift

[ -z $1 ] && echo -e "Usage: $0 [-s] [-u] mail
  -s: sleep before
  -u: apply updates\n
Notify software updates to MAIL.
" && exit 1

n=$(basename $0)
m=$@

[ $s ] && sleep $((RANDOM%600))

l=/tmp/$n.log

lo () { sed -r -e "s/^ +//" -e "s/ {2,}/ /g" -e "s/[-=]{3,}//" $l; }

ma () { mail -s "$(hostname -s): $n $1" $m; }

te () { lo | ma failed; exit 1; }

exec > $l 2>&1

[ -x /usr/bin/dnf ] && d=dnf || d=yum

[ $(id -u) = 0 ] || d="sudo $d"

$d check-update

e=$?

trap te err

if [ $e -eq 100 ]; then
    [ $u ] && echo -e "\n--" && $d -y upgrade

    lo | ma
fi

i=$(rpm -q kernel | tail -1 | cut -d - -f 2-)
r=$(uname -r)
t=$(uptime | sed -r "s/.*up ([^,]*).*/\1/")

[ $r != $i ] && echo "Kernel $i was installed. $r is running for $t." | ma
