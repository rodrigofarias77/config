#!/bin/bash

set -e

[ -z $3 ] && echo 'vm repo keep [mail]' && exit 1

v=$1
r=$2
k=$3
m=$4

d=$(date +%s)

l=/tmp/$(basename $0)-$d.log

te () { mail -s "$HOSTNAME: $0 failed" $m < $l; }

[ $m ] && exec > $l 2>&1 && trap te err

date
echo $@

vboxmanage snapshot $v take $d

cd $(vboxmanage showvminfo $v | sed -nr "s:^Config.* (.*)/$v/.*:\1:p")

borg create --compression=zstd --filter=AME --list --stats $r::$d $v

vboxmanage snapshot $v delete $d

borg prune --keep-last=$k --list --stats $r
