#!/bin/bash

[ -z "$4" ] && echo "Usage: $0 repo keep mail args" && exit 1

r=$1
k=$2
m=$3
a=${@:4}

d=$(date +%s)

l=/tmp/$(basename $0)-$d.log

tty -s && exec > >(tee $l) 2>&1 || exec > $l 2>&1

ma () { mail -s "$HOSTNAME: $0 $1" $m; }

te () { [ $? == 2 ] && tail $l | ma error && exit 1 || grep '^[CE] ' $l | ma warning; }

trap te err

date
echo $@

borg create --compression=zstd --filter=ACME --list --stats $r::$d $a

borg prune --keep-last=$k --list --stats $r
