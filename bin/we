#!/bin/bash

[ -z $1 ] && echo sbrf && exit 1

cd /tmp

l=/tmp/$1.txt
u="https://aviationweather.gov/adds/dataserver_current/httpparam?dataSource=metars&requestType=retrieve&format=csv&hoursBeforeNow=2&mostRecent=true&stationString=$1"

[ -s $l ] && d=$(date -d "$(tail -1 $l | cut -d , -f 3)" -u +%s) || d=0

s=$(type -p {budgie,gnome}-screensaver-command)

[ $(($(date -u +%s) - $d)) -gt 3900 -a "$($s -q | grep inactive)" ] && curl -s $u | tail -1 >> $l

[ ! -s $l ] && echo ! && exit 1

tail -1 $l | cut -d , -f 1 | perl -pe 's:.*KT.*? ([-+]?[A-Z]{2,}).*? (M?[0-9]+)/.*:\1 \2C:'
