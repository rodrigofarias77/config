#!/bin/bash

[ "$1" = -k ] && k=$2 && shift 2 || k=linux
[ "$1" = -s ] && s=1 && shift
[ "$1" = -u ] && u=1 && shift

[ -z $1 ] && echo "Usage: $0 [-k kernel] [-s] [-u] mail" && exit 1

[ $s ] && sleep $((RANDOM%600))

n=$(basename $0)
m=$1

h=yay
l=/tmp/$n.log

lo () { tail -100 $l | tr -s " "; }

ma () { mail -s "$(hostname -s): $n $1" $m; }

te () { lo | ma failed; exit 1; }

trap te err

exec > $l 2>&1

date

$h -Sy
echo

if $h -Qu | grep .; then
    [ $u ] && echo -e "\n--" && $h -Su --devel --noconfirm

    lo | ma
fi

i=$($h -Q $k | sed -r "s/.* ([0-9]*\.[0-9]*\.[0-9]*).*/\1/")
r=$(uname -r | sed "s/-.*//")
t=$(uptime | sed -r "s/.*up ([^,]*).*/\1/")

[ $r != $i ] && echo "Kernel $i installed. $r running for $t." | ma
