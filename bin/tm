#!/bin/bash

set -e
set -o pipefail

[ -z "$3" ] && echo "Usage: $0 dest keep mail args" && exit 1

b=$(readlink -fv $1)
k=$2
m=$3
a=${@:4}

d=$(date +%Y%m%d-%H%M%S)

l=/tmp/$(basename $0)-$d.log

exec > $l 2>&1

t () { tail -100 $l | mail -s "$(hostname -s): $0 failed" $m; }

trap t err

date
echo $@

t=$b/last

TIMEFORMAT=%0lR

time rsync -ahv --link-dest=$t $a $b/$d

rm -fv $t
ln -sv $d $t

ls -d $b/* | grep -Fv $t | head -n -$k | head -2 | xargs -rt rm -r
