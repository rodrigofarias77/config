#!/bin/bash

set -e
set -o pipefail

p=/tmp
t=~/trash
u=30

[ -z "$1" ] && echo -e "$t
-t: trash\n
-g: gzip
-k: keep
-s: sudo
-z: zstd\n
-p: purge $u
-r regex: restore" && exit 1

[ "$1" = -t ] && t=$2 && shift 2

mkdir -pv $t

[ "$1" = -g ] && z=--gzip && shift
[ "$1" = -k ] && k=1 && shift
[ "$1" = -s ] && s=sudo && shift
[ "$1" = -z ] && z=--zstd && shift

case "$1" in
-p)
    for i in $(find $t/*.tar -mtime +365 -or -mtime +$u -size +100k); do
        [ $(($(wc -c < $i)/1024+1024**2)) -gt $(df --output=avail $p | tail -1) ] && ls -hl $i && exit 1

        head ${i%.*}.idx
        mv -iv ${i%.*}.* $p
        echo
    done ;;
-r)
    for i in $(ls -t $t/*.idx) $(ls -t $p/*.idx); do
        if grep -i "$2" $i; then
            d=$(head -1 $i)
            echo $d

            a=${i%.*}.tar
            ls -hl $a

            read -p '? ' r

            if [ "$r" = y ]; then
                cd "$d"
                $s tar -x -f $a -Pkv
                rm -I ${i%.*}.*

                break
            fi
        fi
    done ;;
*)
    b=$t/$(date +%s)

    trap "rm -Iv $b.*; exit 1" err int

    pwd > $b.idx
    $s tar -c -f $b.tar -Pv $z "$@" | tee -a $b.idx

    [ $k ] || $s rm -r "$@"

    ls -hl $b.tar ;;
esac
