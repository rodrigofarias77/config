#!/bin/bash

set -e
set -o pipefail

f=%Y%m%d-%H%M%S
p=/tmp
t=~/trash
u=30

[ -z "$1" ] && echo -e "$t
-t: trash\n
-k: keep
-s: sudo
-z: gzip\n
-p: purge $u
-r regex: restore" && exit 1

[ "$1" = -t ] && t=$2 && shift 2

mkdir -pv $t

[ "$1" = -k ] && k=1 && shift
[ "$1" = -s ] && s=sudo && shift
[ "$1" = -z ] && z=z && shift

case "$1" in
-p)
    for i in $(find $t/*.tar -mtime +365 -or -mtime +$u -size +100k); do
        a=$(df --output=avail $p | tail -1)
        let "$(wc -c < $i) / 1024 + 1048576 > $a" && du -h $i && exit 1
        head ${i%.*}.idx
        mv -iv ${i%.*}.* $p
        echo
    done ;;
-r)
    for i in $(ls -r $t/*.idx) $(ls -r $p/*.idx); do
        if grep -i "$2" $i; then
            d=$(head -1 $i)
            echo $d
            a=${i%.*}.tar
            du -h $a
            read -p '? ' r
            if [ "$r" = y ]; then
                cd "$d"
                $s tar -x -Pkv -f $a
                rm -f ${i%.*}.*
                break
            fi
        fi
    done ;;
*)
    b=$t/$(date +$f)
    pwd > $b.idx
    $s tar -c -Pv$z -f $b.tar "$@" | tee -a $b.idx
    [ $k ] || $s rm -fr "$@"
    du -h $b.tar ;;
esac
