#!/bin/bash

set -e
set -o pipefail

t=~/trash
u=30

[ -z "$1" ] && echo -e "$t
-t: trash\n
-k: keep
-s: sudo
-w: 7d to purge
-z: zstd\n
-p: purge ${u}d
-r regex: restore
" && exit 1

[ "$1" = -t ] && t=$2 && shift 2
[ "$1" = -k ] && k=1 && shift
[ "$1" = -s ] && s=sudo && shift
[ "$1" = -w ] && w=1 && shift
[ "$1" = -z ] && z=--zstd && shift

ry () { read -p '? ' r; [ "$r" = y ]; }

case "$1" in
    -p)
        for i in $(find $t/*.tar -mtime +365 -or -mtime +$u -size +1M); do
            ls -hl $i
            head ${i%.*}.idx
            rm -fv ${i%.*}.*
            echo
        done ;;
    -r)
        for i in $(ls -t $t/*.idx); do
            if grep -i "$2" $i; then
                d=$(head -1 $i)
                a=${i%.*}.tar

                echo $d
                ls -hl $a
                ry && cd "$d" && $s tar -x -f $a -Pkv && rm -fv ${i%.*}.* && break
            fi
        done ;;
    *)
        b=$t/$(date +%s)

        trap "rm -v $b.*; exit 1" err int

        pwd > $b.idx

        [ $z ] && ! tar --help | grep -q zstd && z=--gzip

        $s tar -c -f $b.tar -Pv $z "$@" | tee -a $b.idx

        [ $w ] && $s touch -d "-$(($u - 7)) days" $b.*

        [ $k ] || $s rm -fr "$@"

        ls -hl $b.tar ;;
esac
