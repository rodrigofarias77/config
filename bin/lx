#!/usr/bin/python3

import getopt, os, re, requests, sys
from urllib.parse import unquote

g = getopt.getopt(sys.argv[1:], 'adlpr:s:tuz:')
o = dict(g[0])
a = g[1]

if not a:
    sys.exit('''-a: transmission
-d: sort by date
-l: list only
-p: proxy
-r regex: in name
-s 100: seeds
-z 500: size (MB)\n
search
-t popular-tv
-u user''')

b = 'https://1337x.to'

if '-d' in o:
    u = '%s/sort-search/%s/time/desc/1/' % (b, '+'.join(a))
elif '-t' in o:
    u = '%s/%s' % (b, a[0])
elif '-u' in o:
    u = '%s/user/%s/' % (b, a[0])
else:
    u = '%s/search/%s/1/' % (b, '+'.join(a))

e = {'User-Agent': 'Mozilla/5.0'}
s = {'https': 'socks5h://localhost:1080'} if '-p' in o else None

h = requests.get(u, headers=e, proxies=s).content.decode('ascii', 'ignore')

print(u)
open('/tmp/lx.htm', 'w').write(h)

r = '(?s)"(?P<href>/torrent/(?P<id>.*?)/.*?)"' \
    + '>(?P<name>.*?)<.*?' \
    + 'seeds">(?P<seeds>.*?)<.*?' \
    + 'leeches">(?P<leeches>.*?)<.*?'

if '-u' in o:
    r += 'size.*?">(?P<size>.*?) (?P<unit>.*?)<.*?' \
        + 'coll-5.*?>(?P<date>.*?)<'
else:
    r += 'date">(?P<date>.*?)<.*?' \
        + 'size.*?">(?P<size>.*?) (?P<unit>.*?)<.*?' \
        + '/user/(?P<user>.*?)/'

l = []
z = ['K', 'M', 'G']

for i in re.finditer(r, h):
    t = i.groupdict()

    t['size'] = t['size'].replace(',', '')

    m = float(t['size']) * 1024 ** (z.index(t['unit'][0]) - 1)

    if '-r' in o and not re.search('(?i)' + o['-r'], t['name']) \
            or '-s' in o and int(t['seeds']) < int(o['-s']) \
            or '-z' in o and m < float(o['-z']):
        continue

    l.append(t)

if '-t' in o:
    l.sort(key=lambda t: int(t['id']), reverse=True)

for i, t in reversed(list(enumerate(l))):
    u = t['user'].lower() if '-u' not in o else a[0]

    if '-l' not in o:
        print('%s\n  %s, %s, %s/%s, %s %s, %s' % (
            t['name'],
            i,
            t['date'],
            t['seeds'],
            t['leeches'],
            t['size'],
            t['unit'],
            u))
    else:
        print('%s\n  %s %s, %s' % (
            t['name'],
            t['size'],
            t['unit'],
            u))

if '-l' not in o:
    try:
        i = int(input('? '))
    except:
        sys.exit(1)

    h = requests.get(b + l[i]['href'], headers=e, proxies=s).text

    m = unquote(re.search('magnet:[^"]*', h).group())
    print(m)

    if '-a' in o:
        os.system('transmission-remote -a "%s"' % m)

    print(re.search('http[^"]*\.torrent(?=")', h).group())
