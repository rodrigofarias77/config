#!/usr/bin/python -u

import glob, json, os, random, re, requests, time

def js(h):
    return json.loads(re.search("GAG.App.loadConfigs.(.*)..loadAsynScripts", h).group(1))

def rg(u):
    r = None
    while not r:
        try:
            r = requests.get(u, stream=True, timeout=10)
            time.sleep(random.random())
        except:
            time.sleep(5)
    return r

def tw(h):
    open("/tmp/9gag.htm", "w").write(h)

w = os.path.expanduser("~/9gag")
os.chdir(w)

c = 0
d = str(round(time.time()))
g = "https://9gag.com"
l = []
x = [i.split("-")[2] for i in sorted(glob.glob("*/*.*"))]

h = rg(g).text
tw(h)
j = js(h)["data"]["posts"]

while c < 50:
    for i in j:
        if i["id"] in x or i["id"] in [i["id"] for i in l]:
            c += 1
            print("> " + i["id"])
        else:
            l.append(i)
            c = 0
            print("%s (%s)" % (i["id"], len(l)))

    h = rg(l[-1]["url"]).text
    tw(h)
    j = js(h)["data"]

    if "nextPosts" in j:
        j = j["nextPosts"]
    else:
        print("> ?")
        break

i = input("%s to %s in %s (%s)\n? " % (l[-1]["id"], l[0]["id"], d, len(l)))

if i:
    m = int(i)
else:
    m = 1000

j = 1
os.mkdir(d)
os.chdir(d)

for i in reversed(l):
    if j > m:
        break

    if i["type"] == "Animated":
        u = i["images"]["image460sv"]["url"]
    else:
        u = i["images"]["image700"]["url"]

    t = re.sub(r"[^\w]*", "", i["title"].title())
    n = "%03d-%s-%s.%s" % (j, i["id"], t[:100], u.split(".")[-1])

    open(n, "wb").write(rg(u).content)
    print(i["url"] + " - " + n)

    j += 1

print(os.path.join(w, d))
