#!/usr/bin/python -u

import glob, gzip, html, json, os, random, re, requests, time

def js(h):
    s = re.search("JSON.parse..(.*)..;</", h).group(1)
    return json.loads(bytes(s, "utf-8").decode("unicode_escape"))

def rg(u, s=1):
    r = None
    while not r:
        try:
            r = requests.get(u, stream=True, timeout=10)
            time.sleep(random.random() * s)
        except:
            time.sleep(5)
    return r

def tw(h):
    open("/tmp/9gag.htm", "w").write(h)

w = os.path.expanduser("~/9gag")

c = 0
d = w + "/" + str(round(time.time()))
g = "https://9gag.com"
l = []
x = [os.path.basename(i).split("-")[1] for i in sorted(glob.glob(w + "/*/*"))]

h = rg(g).text
tw(h)
j = js(h)["data"]["posts"]

while c < 50:
    for i in j:
        if i["id"] in x or i["id"] in [i["id"] for i in l]:
            c += 1
            print("> %s - %s" % (i["id"], c))
        else:
            l.append(i)
            c = 0
            t = time.strftime("%F %T", time.localtime(i["creationTs"]))
            print(i["id"] + " - " + t)

    h = rg(j[-1]["url"]).text
    tw(h)
    j = js(h)["data"]

    if "nextPosts" in j:
        j = j["nextPosts"]
    else:
        print("> ?")
        break

i = input("%s to %s (%s)\n? " % (l[-1]["id"], l[0]["id"], len(l)))

if i:
    m = int(i)
else:
    m = 1000

os.mkdir(d)
gzip.open(d + ".json.gz", 'wt').write(json.dumps(l, indent=4))

j = 1

for i in reversed(l):
    if j > m:
        break

    if i["type"] == "Photo":
        r = rg(i["images"]["image700"]["url"])
    elif i["type"] == "Animated":
        r = rg(i["images"]["image460sv"]["url"])
    else:
        print('> %s - %s' % (i["url"], i["type"]))
        continue

    z = int(r.headers['content-length']) / 1024**2

    if z > 5:
        print('> %s - %sM' % (i["url"], round(z, 1)))
        continue

    t = html.unescape(i["title"]).replace("'", "").title()
    t = re.sub("[^0-9A-Za-z]", "", t)[:100]
    n = "%03d-%s-%s.%s" % (j, i["id"], t, r.url.split('.')[-1])

    open(d + "/" + n, "wb").write(r.content)
    print(i["url"] + " - " + n)

    j += 1

print(d)
