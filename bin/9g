#!/usr/bin/python -u

import glob, gzip, html, json, os, re, requests, sys, time

from selenium import webdriver

a = webdriver.FirefoxOptions()
a.add_argument('--headless')
f = webdriver.Firefox(options=a, service_log_path='/tmp/geckodriver.log')

def gj(u):
    while True:
        try:
            time.sleep(1)
            f.get(u)
            h = f.page_source
            open('/tmp/9gag.html', 'w').write(h)
            s = re.search('{.*}', h).group()
            j = json.loads(s)
            open('/tmp/9gag.json', 'w').write(json.dumps(j, indent=4))
            return j
        except KeyboardInterrupt:
            f.quit()
            sys.exit(1)
        except:
            print('> ' + u)
            time.sleep(5)

def gs(u):
    while True:
        try:
            time.sleep(.5)
            return requests.get(u, stream=True)
        except KeyboardInterrupt:
            sys.exit(1)
        except:
            print('> ' + u)
            time.sleep(5)

w = os.path.expanduser('~/9gag')

c = 0
d = w + '/' + str(round(time.time()))
l = []
x = [j['id'] for i in glob.glob(w + '/*.gz') for j in json.loads(gzip.open(i).read())]

p = gj('https://9gag.com/v1/group-posts/group/funny/type/hot')['data']['posts']

while c < 50 and len(l) < 1000:
    for i in p:
        if i['id'] in x:
            c += 1
            print('> %s - %s' % (i['id'], c))
        elif i['postSection']['name'] != 'Funny':
            print('> %s - %s' % (i['id'], i['postSection']['name']))
        else:
            l.append(i)
            x.append(i['id'])
            c = 0
            t = time.strftime('%F %T', time.localtime(i['creationTs']))
            print(i['id'] + ' - ' + t)

    j = gj('https://9gag.com/v1/post/id/' + l[-1]['id'])['data']

    if j['nextPosts']:
        p = j['nextPosts']
    else:
        print('> ?')
        break

f.quit()

i = input('%s to %s (%s)\n? ' % (l[-1]['id'], l[0]['id'], len(l)))

if i:
    m = int(i)

    if m < 1:
        sys.exit()
else:
    m = 500

os.mkdir(d)

f = []
j = 1

for i in reversed(l):
    if j > m:
        break

    if i['type'] == 'Photo':
        r = gs(i['images']['image700']['url'])
    elif i['type'] == 'Animated':
        r = gs(i['images']['image460sv']['url'])
    else:
        print('> %s - %s' % (i['url'], i['type']))
        continue

    z = int(r.headers['content-length']) / 1024**2

    if z > 5:
        print('> %s - %sM' % (i['url'], round(z, 1)))
        continue

    t = html.unescape(html.unescape(i['title']))
    t = re.sub('[^0-9A-Za-z]', '', re.sub("['‘’]", '', t).title())
    n = '%03d-%s-%s.%s' % (j, i['id'], t[:100], r.url.split('.')[-1])

    open(d + '/' + n, 'wb').write(r.content)
    f.append(i)

    print(i['url'] + ' - ' + n)
    j += 1

gzip.open(d + '.json.gz', 'wt').write(json.dumps(f, indent=4))

print(d)
