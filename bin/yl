#!/bin/bash

[ -z "$4" ] && echo "Usage: $0 live secs base mail" && exit 1

u=$1
s=$2
b=$3
m=$4

d=$(date +%s)

l=/tmp/yl-$d.log

exec > $l 2>&1

te () { tail $l | mail -s "$HOSTNAME: $0" $m; }

trap te err int

date

e=$(($d + $s))

while true; do
    [ $d -ge $e ] && break

    ffmpeg -hide_banner -nostats -i "$(yt-dlp -f b -g $u)" -t $(($e - $d)) -c copy $b-$d.mkv

    sleep 60

    d=$(date +%s)
done
